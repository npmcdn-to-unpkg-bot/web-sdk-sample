<!doctype html>
<html>
  <head>
    <title>Voxeet SDK</title>
    <style type="text/css">
      .flex {
        display: flex;
        flex-direction: row;
      }

      .flex > div {
        flex: 1 1 auto;
        margin: 20px;
      }

      .flex > input {
          align-self: center;
      }

      .flex-column {
        display: flex;
        flex-direction: column;
      }

      .flex-column > div {
        flex: 1 1 auto;
      }

      .red {
        border: 1px solid #FF0000;
      }

      input {

      }

    </style>
  </head>
  <body>
    <div class="flex">
      <div id="room-choice">
        <h3>Voxeet Sdk Demo</h3>
        <div>
          <input type="text" id="room-id" autofocus="">
        </div>
        <div>
          <button id="demo-button" disabled="true">Demo</button>
          <button id="create-button" disabled="true">Create</button>
          <button id="join-button" disabled="true">Join</button>
          <button id="leave-button" disabled="true">Leave</button>
          <button id="mute-button">Mute</button>
        </div>
      </div>

      <div id="participants">
        <h3>Participants</h3>
        <div id="participant-list" class="flex-column">
        </div>
      </div>

      <div id="messages">
        <h3>Messages</h3>
        <div>
          <input type="text" id="message-input" autofocus="">
          <button id="send-button">Send</button>
        </div>
      </div>
    </div>

    <script src="https://npmcdn.com/@voxeet/voxeet-web-sdk@0.2.10" type="text/javascript"></script>
    <script type="text/javascript">
      var participants = [];

      function addParticipant(userId, userInfo, stream) {
        var participantList = document.getElementById('participant-list');
        participants[userId] = {x: 0.0, y: 0.5}; // Initial position

        if (voxeet.userId !== userId) {

          var node = document.createElement('div');

          node.innerHTML = '<div>' + userInfo['name'] + '</div>';
          node.setAttribute('id', "participant-" + userId);
          node.setAttribute('class', 'flex red');

          var horizontalRange = document.createElement('input');
          horizontalRange.setAttribute('type', 'range');
          horizontalRange.setAttribute('id', userId);
          horizontalRange.min = -1.0;
          horizontalRange.max = 1.0;
          horizontalRange.step = 0.1;
          horizontalRange.value= 0.0;

          horizontalRange.oninput = function(e) {
            console.log(e.target.value);
            var userId = e.target.getAttribute('id');
            participants[userId].x = e.target.value;

            updatePosition(userId);
          };

          node.appendChild(horizontalRange);

          var verticalRange = document.createElement('input');
          verticalRange.setAttribute('type', 'range');
          //verticalRange.setAttribute('orient', 'vertical');
          verticalRange.setAttribute('id', userId);
          verticalRange.min = 0.0;
          verticalRange.max = 1.0;
          verticalRange.step = 0.1;
          verticalRange.value= 0.5;

          verticalRange.oninput = function(e) {
            console.log(e.target.value);
            var userId = e.target.getAttribute('id');
            participants[userId].y = e.target.value;

            updatePosition(userId);
          };

          node.appendChild(verticalRange);

          var muteButton = document.createElement('button');
          muteButton.setAttribute('id', userId);
          muteButton.innerHTML = 'Mute';

          muteButton.onclick = function(e) {
            var userId = e.target.getAttribute('id');
            voxeet.toggleMute(userId);
          }

          node.appendChild(muteButton);

          participantList.appendChild(node);

          updatePosition(userId);
        }
      }

      function removeParticipant(userId) {
        var node = document.getElementById("participant-" + userId);
        participants[userId] = {x: 0.0, y: 0.5}; // Initial position
        if (node != undefined) {
          node.parentNode.removeChild(node);
        }
      }

      function updatePosition(userId) {
        if (participants[userId] !== undefined) {
          voxeet.setUserPosition(userId, participants[userId].x, participants[userId].y);
        }
      }

      function enableUI() {
        var roomInput = document.getElementById('room-id');
        var messageInput = document.getElementById('message-input');
        var demoButton = document.getElementById('demo-button');
        var createButton = document.getElementById('create-button');
        var joinButton = document.getElementById('join-button');
        var sendButton = document.getElementById('send-button');
        var leaveButton = document.getElementById('leave-button');
        var muteButton = document.getElementById('mute-button');

        demoButton.disabled = false;
        createButton.disabled = false;
        joinButton.disabled = false;

        demoButton.onclick = function() {
          voxeet.createDemoConference();
        }

        createButton.onclick = function() {
          var alias = "";

          if (roomInput !== undefined) {
            alias = roomInput.value;
          }

          voxeet.createConference(alias)
                .then(function(res){
                  roomInput.value = res.data.conferenceAlias;
                })
                .catch(function(e) {
                  console.error(e);
                });
        }

        joinButton.onclick = function() {
          if (roomInput !== undefined) {
            voxeet.joinConference(roomInput.value);
          }
        }

        sendButton.onclick = function() {
          voxeet.sendConferenceMessage(messageInput.value);
        }

        leaveButton.onclick = function() {
          voxeet.leaveConference();
        }

        muteButton.onclick = function() {
          voxeet.toggleMute(voxeet.userId);
        }
      }

      var voxeet = new VoxeetSdk();
      var participants = [];
      var timeout = null;

      voxeet.on('conferenceJoined', function() {
        document.getElementById('leave-button').disabled = false;
        document.getElementById('join-button').disabled = true;

        timeout = setInterval(function () {

          for (var userId in participants) {
            var node = document.getElementById('participant-' + userId);
            if (node != null) {
              voxeet.isUserSpeaking(userId, function(isSpeaking) {
                if (isSpeaking) {
                  node.setAttribute('class', 'flex red');
                } else {
                  node.setAttribute('class', 'flex');
                }
              });
            }
          }
        }, 500);
      });

      voxeet.on('conferenceLeft', function() {
        document.getElementById('leave-button').disabled = true;
        document.getElementById('join-button').disabled = false;
      });

      voxeet.on('participantAdded', function(userId, userInfo, stream) {
        addParticipant(userId, userInfo, stream);
        if (userId !== voxeet.userId) {
          participants.push(userId);
        }
      });

      voxeet.on('participantRemoved', function(userId) {
        removeParticipant(userId);
        if (userId !== voxeet.userId) {
          participants = participants.slice(participants.indexOf(userId), 1);
        }
      });

      voxeet.on('messageReceived', function(msg) {
        var node = document.createElement('div');
        node.innerHTML = msg;

        document.getElementById('messages').appendChild(node);
      });

      voxeet.initialize("MyCustomerKey", "MyCustomerSecret", {name: "John Doe"})
            .then(function(myUserId){
                enableUI();
            });

    </script>
  </body>
</html>
